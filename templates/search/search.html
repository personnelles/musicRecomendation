{% extends 'base/base.html' %}
{% load static %}
{% load common %}
{% block title %}
    搜索结果
{% endblock %}
<style>

    .badge-custom {
        background-color: #6c757d;
        color: white;
        padding: 6px 12px;
        border-radius: 12px;
        margin: 2px;
        text-decoration: none;
        transition: background-color 0.3s ease;
    }

    .badge-custom:hover {
        background-color: #5a6268;
        text-decoration: none;
    }

    .table {
        border-radius: 8px;
        overflow: hidden;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #343a40;
        position: relative;
        display: inline-block;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .page-title::after {
        content: '';
        width: 60%;
        height: 4px;
        background: linear-gradient(90deg, #00c6ff, #0072ff);
        position: absolute;
        left: 20%;
        bottom: 0;
        border-radius: 2px;
        animation: titleLine 1.5s ease-in-out infinite alternate;
    }

    @keyframes titleLine {
        from {
            width: 30%;
            left: 35%;
        }
        to {
            width: 60%;
            left: 20%;
        }
    }
</style>

{% block content %}
    <h1 class="page-title my-4 text-center">
        <i class="fas fa-search me-2 text-primary"></i>搜索结果
    </h1>


    <div class="pagination d-flex justify-content-center">
        <div class="pagination-links d-flex flex-wrap gap-2">
            {% if page_obj.has_previous %}
                <a href="?{{ request.GET.urlencode|update_query:'page=1' }}"
                   class="btn btn-outline-primary btn-custom">« 第一页</a>
                {% with p_page="page="|my_add:page_obj.previous_page_number %}
                    <a href="?{{ request.GET.urlencode|update_query:p_page }}"
                       class="btn btn-outline-primary btn-custom">上一页</a>
                {% endwith %}

            {% else %}
                <a href="#" class="btn btn-outline-primary btn-custom disabled">« 第一页</a>
                <a href="#" class="btn btn-outline-primary btn-custom disabled">上一页</a>
            {% endif %}

            <span class="current align-self-center text-muted">
                    第 {{ page_obj.number }} 页，共 {{ page_obj.paginator.num_pages }} 页
                </span>

            {% if page_obj.has_next %}
                {% with n_page="page="|my_add:page_obj.next_page_number %}
                    {% with l_page="page="|my_add:page_obj.paginator.num_pages %}
                        <a href="?{{ request.GET.urlencode|update_query:n_page }}"
                           class="btn btn-outline-primary btn-custom">下一页</a>
                        <a href="?{{ request.GET.urlencode|update_query:l_page }}"
                           class="btn btn-outline-primary btn-custom">最后一页 »</a>
                    {% endwith %}
                {% endwith %}
            {% else %}
                <a href="#" class="btn btn-outline-primary btn-custom disabled">下一页</a>
                <a href="#" class="btn btn-outline-primary btn-custom disabled">最后一页 »</a>
            {% endif %}
        </div>
    </div>
    <table class="table table-striped table-hover" aria-labelledby="music-table-title">
        <thead>
        <tr>
            <th>#</th>
            <th scope="col">歌名</th>
            <th scope="col">作家</th>
            <th scope="col">歌曲流派</th>
            <th scope="col">分数</th>
            <th scope="col">操作</th>
        </tr>

        </thead>
        <tbody>
        {% for song in page_obj %}
            <tr>
                <td>
                    {{ song.id }}
                </td>
                <td>{{ song.name }}
                    <var class="var-total-play-count"
                         data-count="{{ song.total_play_count }}" id="play-{{ song.id }}">
                        {{ song.total_play_count }}
                    </var>
                </td>
                <td>{{ song.artist }}</td>
                <td>
                    {% for e in song.list_labels|split_by_space %}
                        <a href="?{{ request.GET.urlencode|update_query:'tag=' }}{{ e }}"
                           class="badge-custom" data-tag="{{ e }}">{{ e }}</a>
                    {% endfor %}
                </td>
                <td id="score-{{ song.id }}">
                    {{ song.score|default_if_none:"未评分" }}
                </td>
                <td>
                    <button data-index="{{ song.id }}"
                            class="cc-xxxx btn btn-action {% if song.is_collected %}btn-uncollect{% else %}btn-collect{% endif %}"
                            aria-label="{% if song.is_collected %}取消收藏{% else %}收藏{% endif %}">
                        <i class="{% if song.is_collected %}fas{% else %}far{% endif %} fa-bookmark">
                        </i>
                    </button>

                    <button class="btn-action btn-play play-music-button"
                            data-name="{{ song.name }}" data-index="{{ song.id }}" data-score="{{ song.score }}"
                            data-artist="{{ song.artist }}"
                    >
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="score-song" data-index="{{ song.id }}" data-name="{{ song.name }}">
                        打分
                    </button>
                </td>
            </tr>

        {% endfor %}
        </tbody>
    </table>
    <div>
        <dialog id="dig-for-score-song" class="dialog-glass rounded-4 p-4 border-0 shadow-lg">
            <form id="form-for-score-song" method="post" action="/index/score/">
                {% csrf_token %}
                <fieldset class="border-0">
                    <legend id="leg-title" class="fs-5 fw-bold text-primary mb-3">给...打分</legend>
                    <label for="score-song">
                        <p class="text-muted mb-2">请选择一个 0 到 10 的分数</p>
                    </label>
                    <input id="score-song"
                           type="number"
                           min="0"
                           max="10"
                           name="score"
                           class="form-control mb-3"
                           required
                           placeholder="请输入分数"
                           step="1"
                    />

                    <div class="d-flex justify-content-end gap-3">
                        <button type="submit" class="btn btn-success px-4">
                            提交
                        </button>
                        <button type="button" id="btn-dig-cancel" class="btn btn-outline-secondary px-4">
                            取消
                        </button>
                    </div>
                </fieldset>
            </form>
        </dialog>
    </div>
    <script src="{% static 'jquery/js/all.min.js' %}"></script>
    <script>
        $(document).ready(function () {
            const has_src_song_ids = new Set()
            let cur_button = null;
            const audio_div = $('#div-play-music');
            const audio_ele = $('#audio-play-music')[0]; // 原生音频元素
            const soundwave = $('.soundwave');
            const music_cover_ele = $("#img-play-music-cover")[0]
            const play_music_wrapper = $('#play-music-wrapper');
            const dig_score_for_song = $('#dig-for-score-song')[0]

            const for_score_for_song = document.getElementById('form-for-score-song')
            // const js_audio_play_music = document.querySelector("#audio-play-music")
            const leg_title = document.getElementById('leg-title')
            const btn_dig_cancel = document.getElementById('btn-dig-cancel')
            btn_dig_cancel.addEventListener('click', async function (e) {
                dig_score_for_song.close()
            })

            const get_music_cover_img_by_id = async (id) => {

                const response = await fetch(`/index/cover/${id}`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    }
                })
                return await response.json()
            }

            const play_music = async (id) => {
                const song = await fetch(`/index/get_song_by_id/${id}`, {
                    method: 'POST',
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    }
                });
                if (song.ok) {
                    const blob = await song.blob()
                    audio_ele.src = URL.createObjectURL(blob)
                    has_src_song_ids.add(id)
                    await audio_ele.play();
                    return true
                } else {
                    return false
                }
            }

            const sendRequest = async (url, data) => {
                try {
                    return await $.ajax({
                        url: url,
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/json"
                        },
                        data: JSON.stringify(data)
                    });
                } catch (error) {
                    alert("操作失败，请稍后重试");
                    return null;
                }
            }

            for_score_for_song.addEventListener('submit', async function (e) {
                console.log(this.score.value, this)
                e.preventDefault()
                const id = this.dataset.index
                const score = this.score.value
                const response = await sendRequest(`/index/score/${id}`, {score: score})
                if (response.success) {
                    dig_score_for_song.close()
                    document.getElementById(`score-${id}`).textContent = score
                }
            })

            $(".cc-xxxx").on("click", async function () {
                const $button = $(this);
                const id = $button.data("index");
                const response = await sendRequest(`/index/collect_song/${id}`, {song_id: id});

                if (response) {
                    alert(response.message);
                    $button.html(`<i class="${response.is_collected ? "fas" : "far"} fa-bookmark"></i>`);
                }
            });


            // 播放歌曲按钮
            $('.play-music-button').on('click', async function (e) {
                const source = $(this);
                audio_ele.dataset.index = source.data('index')
                audio_ele.dataset.name = source.data('name')

                const id = audio_ele.dataset.index
                // audio_ele.src = `/index/get_song_by_id/${id}`
                if (cur_button !== null) {
                    cur_button.disabled = false;
                    cur_button.innerHTML = '<i class="fas fa-play me-2"></i>'
                }
                document.getElementById(`play-${id}`).textContent = +(document.getElementById(`play-${id}`).textContent) + 1
                cur_button = source[0];
                cur_button.disabled = true;

                const res = await play_music(id)
                const add_play_count = await sendRequest(`/index/play_song/${id}`)
                const data = await get_music_cover_img_by_id(id)

                music_cover_ele.src = `data:image/jpeg;base64,${data.image}`
                sessionStorage.setItem("playing_song_id", `${id}`)
                if (res) {
                    play_music_wrapper.addClass('show')
                    console.log(data)
                    audio_ele.dataset.album = data.album

                }
                $("#song-name").text(source.data('name'))
                $("#song-album").text(data.album)
                $('#current-song-title').text(source.data('name'));
                music_cover_ele.src = `data:image/jpeg;base64,${data.image}`
                const icon = cur_button.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                    cur_button.innerHTML = '<i class="fas fa-pause me-2"></i>';
                }
            });


            $('#audio-play-music').on('play', async function (e) {
                cur_button.disabled = true
                cur_button.innerHTML = '<i class="fas fa-pause me-2"></i>'
            })

            $('#audio-play-music').on('pause', async function (e) {
                cur_button.disabled = false
                cur_button.innerHTML = '<i class="fas fa-play me-2"></i>'
            })

            // 歌曲打分按钮
            $('.score-song').on('click', async function (e) {
                const btn = $(this)
                const id = btn.data('index')
                const name = btn.data('name')
                leg_title.textContent = `给歌曲${name}打分`
                dig_score_for_song.showModal()
                for_score_for_song.dataset['index'] = id
            })
        });
    </script>
{% endblock %}


